#:import dp kivy.metrics.dp

<HistoryButton>:
    size_hint_y: None
    height: max(dp(48), self.texture_size[1] + dp(12))
    background_normal: ''
    background_color: (0.85, 0.2, 0.25, 1) if self.selected else (0.2, 0.2, 0.2, 1)
    color: 1, 1, 1, 1
    font_size: '16sp'
    halign: 'left'
    text_size: self.width - dp(8), None
    padding: dp(8), 0

<MainScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(16)
        spacing: dp(12)

        BoxLayout:
            orientation: 'vertical'
            spacing: dp(4)
            size_hint_y: None
            height: self.minimum_height

            Label:
                text: 'Генератор координат A4'
                font_size: '22sp'
                bold: True
                size_hint_y: None
                height: self.texture_size[1]

            Label:
                text: 'Поточний № {}'.format('{:03d}'.format(root.controller.latest_point['id']) if root.controller and root.controller.latest_point else '—')
                font_size: '16sp'
                size_hint_y: None
                height: self.texture_size[1] + dp(6)

        PointBoard:
            size_hint_y: 0.55
            image_source: 'Image.jpg'
            display_all: False
            controller: root.controller

        BoxLayout:
            size_hint_y: None
            height: dp(56)
            spacing: dp(12)

            Label:
                text: root.controller.caliber_display_text if root.controller else '—'
                font_size: '18sp'
                halign: 'left'
                valign: 'middle'
                text_size: self.width, None
                size_hint_x: None
                width: dp(60)
                size_hint_y: None
                height: self.texture_size[1] + dp(8)

            Label:
                text: root.controller.calibration_text if root.controller else '—'
                font_size: '18sp'
                bold: True
                halign: 'center'
                valign: 'middle'
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1] + dp(8)

            Label:
                text: root.controller.calibration_distance_text if root.controller else '25 м'
                font_size: '18sp'
                halign: 'right'
                valign: 'middle'
                text_size: self.width, None
                size_hint_x: None
                width: dp(60)
                size_hint_y: None
                height: self.texture_size[1] + dp(8)


        BoxLayout:
            size_hint_y: None
            height: dp(48)
            spacing: dp(8)

            # Відстань
            LockableSpinner:
                text: root.controller.selected_distance_label if root.controller else '25 м'
                values: root.controller.distance_labels if root.controller else []
                size_hint_x: None
                width: dp(110)
                background_normal: ''
                background_color: (0.1, 0.45, 0.95, 1) if root.controller and not root.controller.controls_locked else (0.3, 0.3, 0.3, 1)
                locked: root.controller.controls_locked if root.controller else False
                disabled: root.controller.controls_locked if root.controller else False
                on_text: root.controller.handle_distance_selection(self.text) if root.controller else None

            # Калібр
            LockableSpinner:
                text: root.controller.selected_caliber if root.controller else '—'
                values: root.controller.caliber_options if root.controller else []
                background_normal: ''
                background_color: (0.1, 0.45, 0.95, 1) if root.controller and not root.controller.controls_locked else (0.3, 0.3, 0.3, 1)
                locked: root.controller.controls_locked if root.controller else False
                disabled: root.controller.controls_locked if root.controller else False
                on_text: root.controller.set_caliber(self.text) if root.controller else None


            PrimaryButton:
                text: 'Скинути'
                size_hint_x: None
                width: dp(120)
                on_release: root.controller.finish_session() if root.controller else None

<HistoryScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(16)
        spacing: dp(12)

        Label:
            text: 'Усі згенеровані точки'
            font_size: '20sp'
            bold: True
            size_hint_y: None
            height: self.texture_size[1] + dp(4)

        PointBoard:
            size_hint_y: 0.8
            image_source: 'Image.jpg'
            display_all: True
            controller: root.controller
            show_until_selection: True

        Label:
            text: 'Історія поправок'
            font_size: '16sp'
            size_hint_y: None
            height: self.texture_size[1] + dp(4)

        RecycleView:
            id: history_rv
            size_hint_y: 0.4
            viewclass: 'HistoryButton'
            bar_width: dp(4)
            scroll_type: ['bars', 'content']
            RecycleBoxLayout:
                default_size: None, dp(48)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'

RootWidget:
    orientation: 'vertical'
    spacing: dp(6)

    ScreenManager:
        id: screen_manager

        MainScreen:
            name: 'main'
            controller: app.root

        HistoryScreen:
            name: 'history'
            controller: app.root

    BoxLayout:
        size_hint_y: None
        height: dp(56)
        padding: dp(8)
        spacing: dp(8)

        Button:
            text: 'Головна'
            background_normal: ''
            background_color: (0.1, 0.45, 0.95, 1) if root.ids.screen_manager.current == 'main' else (0.3, 0.3, 0.3, 1)
            on_release: root.switch_to('main')

        Button:
            text: 'Історія'
            background_normal: ''
            background_color: (0.1, 0.45, 0.95, 1) if root.ids.screen_manager.current == 'history' else (0.3, 0.3, 0.3, 1)
            on_release: root.switch_to('history')
